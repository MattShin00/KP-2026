<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#f0c04a" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="King's Planner" />
  <link rel="manifest" href="manifest.json" />
  <title>King's Planner</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet" />
  <style>
    /* ===========================  CSS VARIABLES  =========================== */
    :root {
      --bg: #0d0f1a;
      --surface: #141728;
      --surface2: #1c2035;
      --surface3: #222640;
      --border: rgba(255, 255, 255, 0.07);
      --border-hover: rgba(255, 255, 255, 0.15);
      --accent: #f0c04a;
      --accent2: #e8834a;
      --text: #e8eaf0;
      --text-muted: #7a7f9a;
      --text-dim: #4a4e6a;
      --glass: rgba(255, 255, 255, 0.04);
      --glass-hover: rgba(255, 255, 255, 0.07);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      --shadow-sm: 0 2px 12px rgba(0, 0, 0, 0.3);
      --radius: 14px;
      --radius-sm: 8px;
      --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --am-color: #f0c04a;
      --pm-color: #e8834a;
      --sync-ok: #4ade80;
      --sync-busy: #f0c04a;
      --sync-off: #7a7f9a;
    }

    body.white-mode {
      --bg: #f5f5f0;
      --surface: #fff;
      --surface2: #f0ede8;
      --surface3: #e8e4dc;
      --border: rgba(0, 0, 0, 0.09);
      --border-hover: rgba(0, 0, 0, 0.18);
      --text: #1a1c28;
      --text-muted: #6b6f88;
      --text-dim: #a0a4b8;
      --glass: rgba(0, 0, 0, 0.03);
      --glass-hover: rgba(0, 0, 0, 0.06);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
      --shadow-sm: 0 2px 12px rgba(0, 0, 0, 0.08);
    }

    body.white-mode {
      background-image: radial-gradient(ellipse 80% 50% at 20% 0%, rgba(240, 192, 74, .1) 0%, transparent 60%), radial-gradient(ellipse 60% 40% at 80% 100%, rgba(232, 131, 74, .07) 0%, transparent 50%);
    }

    body.white-mode #brain-dump {
      background-image: radial-gradient(circle, var(--surface3) 1px, transparent 1px);
      background-size: 18px 18px;
      background-color: var(--surface2);
    }

    body.white-mode #date-input {
      color: var(--text);
    }

    body.white-mode #date-input::-webkit-calendar-picker-indicator {
      filter: invert(0);
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      font-size: 14px;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      background-image: radial-gradient(ellipse 80% 50% at 20% 0%, rgba(240, 192, 74, .06) 0%, transparent 60%), radial-gradient(ellipse 60% 40% at 80% 100%, rgba(232, 131, 74, .05) 0%, transparent 50%);
      transition: background-color .3s, background-image .3s;
    }

    body,
    body * {
      transition: background-color .3s, border-color .3s, color .25s;
    }

    .priority-check,
    .progress-fill {
      transition: background .2s, border-color .2s, width .4s cubic-bezier(.4, 0, .2, 1);
    }

    /* ========================= SETUP WIZARD ========================= */
    #setup-screen {
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .setup-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 40px 36px;
      max-width: 480px;
      width: 100%;
      box-shadow: var(--shadow);
    }

    .setup-logo {
      width: 64px;
      height: 56px;
      background: var(--accent);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 15px;
      color: #0d0f1a;
      text-align: center;
      line-height: 1.25;
      margin-bottom: 20px;
    }

    .setup-card h2 {
      font-size: 1.4rem;
      font-weight: 800;
      margin-bottom: 6px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .setup-card p {
      font-size: .83rem;
      color: var(--text-muted);
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .setup-steps {
      list-style: none;
      margin-bottom: 24px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .setup-steps li {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: .8rem;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .step-num {
      min-width: 22px;
      height: 22px;
      border-radius: 50%;
      background: rgba(240, 192, 74, .15);
      color: var(--accent);
      font-weight: 700;
      font-size: .68rem;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-top: 1px;
    }

    .setup-input-wrap {
      position: relative;
      margin-bottom: 12px;
    }

    #script-url-input {
      width: 100%;
      padding: 12px 14px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: .82rem;
      outline: none;
      transition: border-color .2s;
    }

    #script-url-input:focus {
      border-color: rgba(240, 192, 74, .4);
    }

    #script-url-input::placeholder {
      color: var(--text-dim);
    }

    .setup-actions {
      display: flex;
      gap: 10px;
    }

    .setup-btn {
      flex: 1;
      padding: 12px;
      border-radius: var(--radius-sm);
      border: none;
      font-family: 'Inter', sans-serif;
      font-size: .82rem;
      font-weight: 700;
      cursor: pointer;
      transition: all .2s;
    }

    .setup-btn.primary {
      background: var(--accent);
      color: #0d0f1a;
    }

    .setup-btn.primary:hover {
      background: #e8b035;
    }

    .setup-btn.secondary {
      background: var(--glass);
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .setup-btn.secondary:hover {
      background: var(--glass-hover);
      color: var(--text);
    }

    .setup-msg {
      font-size: .76rem;
      margin-top: 10px;
      min-height: 20px;
      text-align: center;
    }

    .setup-msg.ok {
      color: var(--sync-ok);
    }

    .setup-msg.err {
      color: #f87171;
    }

    .setup-skip {
      text-align: center;
      margin-top: 14px;
    }

    .setup-skip a {
      font-size: .72rem;
      color: var(--text-dim);
      cursor: pointer;
      text-decoration: underline;
    }

    .setup-skip a:hover {
      color: var(--text-muted);
    }

    /* ========================= LAYOUT ========================= */
    .app-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 20px 40px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .brand-logo {
      width: 60px;
      height: 52px;
      background: var(--accent);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 15px;
      letter-spacing: .3px;
      color: #0d0f1a;
      flex-shrink: 0;
      text-align: center;
      line-height: 1.25;
      padding: 4px;
    }

    .brand-title {
      display: flex;
      flex-direction: column;
    }

    .brand-title h1 {
      font-size: 1.55rem;
      font-weight: 800;
      letter-spacing: -.5px;
      line-height: 1.1;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .brand-title span {
      font-size: .78rem;
      color: var(--text-muted);
      font-weight: 500;
      margin-top: 1px;
    }

    /* Sync badge */
    .sync-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 20px;
      border: 1px solid var(--border);
      font-size: .7rem;
      font-weight: 600;
      color: var(--text-muted);
      background: var(--glass);
      white-space: nowrap;
    }

    .sync-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--sync-off);
      flex-shrink: 0;
    }

    .sync-badge.ok .sync-dot {
      background: var(--sync-ok);
    }

    .sync-badge.busy .sync-dot {
      background: var(--sync-busy);
      animation: pulse 1s infinite;
    }

    .sync-badge.off .sync-dot {
      background: var(--sync-off);
    }

    .sync-badge.no-sync {
      opacity: .4;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: .4;
      }
    }

    /* Date nav */
    .date-nav {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 8px 12px;
      box-shadow: var(--shadow-sm);
    }

    .date-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-muted);
      cursor: pointer;
      transition: var(--transition);
      font-size: 1rem;
    }

    .date-btn:hover {
      background: var(--glass-hover);
      border-color: var(--border-hover);
      color: var(--text);
    }

    .date-display {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 160px;
    }

    #date-input {
      background: transparent;
      border: none;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: .95rem;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
      outline: none;
      width: 100%;
    }

    #date-input::-webkit-calendar-picker-indicator {
      filter: invert(.6);
      cursor: pointer;
    }

    #date-weekday {
      font-size: .7rem;
      color: var(--text-muted);
      font-weight: 500;
      margin-top: 2px;
    }

    .today-btn {
      padding: 6px 12px;
      background: rgba(240, 192, 74, .12);
      border: 1px solid rgba(240, 192, 74, .25);
      border-radius: 6px;
      color: var(--accent);
      font-size: .72rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
    }

    .today-btn:hover {
      background: rgba(240, 192, 74, .2);
      border-color: rgba(240, 192, 74, .4);
    }

    /* Header actions */
    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--glass);
      color: var(--text-muted);
      font-size: .78rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .action-btn:hover {
      background: var(--glass-hover);
      border-color: var(--border-hover);
      color: var(--text);
    }

    .action-btn.primary {
      background: rgba(240, 192, 74, .1);
      border-color: rgba(240, 192, 74, .3);
      color: var(--accent);
    }

    .action-btn.primary:hover {
      background: rgba(240, 192, 74, .2);
      border-color: rgba(240, 192, 74, .5);
    }

    /* Theme toggle */
    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 7px;
      padding: 7px 13px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--glass);
      color: var(--text-muted);
      font-size: .78rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
    }

    .theme-toggle:hover {
      background: var(--glass-hover);
      border-color: var(--border-hover);
      color: var(--text);
    }

    .toggle-track {
      width: 32px;
      height: 17px;
      border-radius: 99px;
      background: var(--surface3);
      border: 1px solid var(--border-hover);
      position: relative;
      transition: background .25s;
      flex-shrink: 0;
    }

    .toggle-thumb {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 11px;
      height: 11px;
      border-radius: 50%;
      background: var(--text-muted);
      transition: transform .25s cubic-bezier(.4, 0, .2, 1), background .25s;
    }

    body.white-mode .toggle-track {
      background: rgba(240, 192, 74, .25);
      border-color: rgba(240, 192, 74, .4);
    }

    body.white-mode .toggle-thumb {
      transform: translateX(15px);
      background: var(--accent);
    }

    /* Settings icon btn */
    .icon-btn {
      width: 34px;
      height: 34px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--glass);
      color: var(--text-muted);
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .icon-btn:hover {
      background: var(--glass-hover);
      border-color: var(--border-hover);
      color: var(--text);
    }

    /* Main content */
    .main-content {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 20px;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card-header {
      padding: 14px 18px 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title {
      font-size: .85rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: var(--text-muted);
    }

    .card-badge {
      font-size: .65rem;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 20px;
      background: rgba(240, 192, 74, .12);
      color: var(--accent);
      border: 1px solid rgba(240, 192, 74, .2);
    }

    /* Left panel */
    .left-panel {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .priorities-list {
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .priority-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      transition: var(--transition);
    }

    .priority-item:hover {
      border-color: var(--border-hover);
      background: var(--surface3);
    }

    .priority-item.completed {
      opacity: .5;
    }

    .priority-item.completed .priority-input {
      text-decoration: line-through;
    }

    .priority-num {
      font-size: .65rem;
      font-weight: 800;
      color: var(--accent);
      min-width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(240, 192, 74, .12);
      border-radius: 4px;
      flex-shrink: 0;
      margin-top: 1px;
    }

    .priority-input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: .85rem;
      font-weight: 500;
      outline: none;
      resize: none;
      height: 40px;
      line-height: 1.5;
    }

    .priority-input::placeholder {
      color: var(--text-dim);
    }

    .priority-check {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid var(--border-hover);
      background: transparent;
      cursor: pointer;
      flex-shrink: 0;
      margin-top: 1px;
      position: relative;
    }

    .priority-check:hover {
      border-color: var(--accent);
      background: rgba(240, 192, 74, .1);
    }

    .priority-check.checked {
      background: var(--accent);
      border-color: var(--accent);
    }

    .priority-check.checked::after {
      content: 'âœ“';
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #0d0f1a;
      font-weight: 800;
    }

    .progress-bar-wrap {
      padding: 0 16px 14px;
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      font-size: .68rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .progress-bar {
      height: 4px;
      background: var(--surface3);
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 2px;
      width: 0%;
    }

    .brain-dump-body {
      padding: 14px 16px;
    }

    #brain-dump {
      width: 100%;
      height: 240px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: .82rem;
      line-height: 1.8;
      resize: vertical;
      outline: none;
      transition: border-color .2s;
      background-image: radial-gradient(circle, var(--surface3) 1px, transparent 1px);
      background-size: 18px 18px;
    }

    #brain-dump:focus {
      border-color: rgba(240, 192, 74, .3);
      box-shadow: 0 0 0 3px rgba(240, 192, 74, .06);
    }

    #brain-dump::placeholder {
      color: var(--text-dim);
    }

    .stats-grid {
      padding: 12px 16px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .stat-item {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .stat-label {
      font-size: .65rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: .8px;
    }

    .stat-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text);
    }

    .stat-value.accent {
      color: var(--accent);
    }

    .stat-value.accent2 {
      color: var(--accent2);
    }

    /* Time blocks */
    .timebox-header {
      padding: 14px 18px;
      border-bottom: 1px solid var(--border);
      display: grid;
      grid-template-columns: 56px 1fr 1fr;
      gap: 0;
      align-items: center;
    }

    .time-col-label {
      font-size: .7rem;
      font-weight: 700;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
    }

    .time-col-label:first-child {
      text-align: left;
    }

    .time-row {
      display: grid;
      grid-template-columns: 56px 1fr 1fr;
      border-bottom: 1px solid var(--border);
      transition: background var(--transition);
    }

    .time-row:last-child {
      border-bottom: none;
    }

    .time-row:hover {
      background: var(--glass);
    }

    .time-label {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 6px;
      font-size: .82rem;
      font-weight: 700;
      height: 36px;
      border-right: 1px solid var(--border);
      flex-shrink: 0;
    }

    .time-label.am {
      color: var(--am-color);
    }

    .time-label.pm {
      color: var(--pm-color);
    }

    .time-label.noon {
      color: #ff6b6b;
      font-size: .7rem;
      font-weight: 800;
      letter-spacing: .5px;
    }

    .time-input-cell {
      padding: 3px 6px;
      border-right: 1px solid var(--border);
      display: flex;
      align-items: center;
    }

    .time-input-cell:last-child {
      border-right: none;
    }

    .time-input {
      width: 100%;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: .8rem;
      font-weight: 400;
      padding: 4px 6px;
      border-radius: 4px;
      transition: var(--transition);
      height: 30px;
    }

    .time-input:focus {
      background: var(--surface3);
      color: var(--text);
    }

    .time-input::placeholder {
      color: var(--text-dim);
      font-size: .72rem;
    }

    .time-input.has-content {
      color: var(--text);
      font-weight: 500;
    }

    .time-row.am-row .time-input.has-content {
      background: rgba(240, 192, 74, .06);
      border-radius: 4px;
    }

    .time-row.pm-row .time-input.has-content {
      background: rgba(232, 131, 74, .06);
      border-radius: 4px;
    }

    .footer {
      text-align: center;
      color: var(--text-dim);
      font-size: .68rem;
      padding: 8px 0;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px 18px;
      font-size: .8rem;
      color: var(--text);
      box-shadow: var(--shadow);
      transform: translateY(80px);
      opacity: 0;
      transition: transform .3s cubic-bezier(.4, 0, .2, 1), opacity .3s;
      z-index: 200;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    /* Notice Card */
    .notice-card {
      position: relative;
    }

    .notice-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent2);
      flex-shrink: 0;
      box-shadow: 0 0 6px var(--accent2);
      animation: noticePulse 2.5s ease-in-out infinite;
    }

    @keyframes noticePulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: .4;
      }
    }

    .notice-content {
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .notice-text {
      background: linear-gradient(135deg, rgba(232, 131, 74, .08), rgba(240, 192, 74, .05));
      border: 1px solid rgba(232, 131, 74, .2);
      border-radius: var(--radius-sm);
      padding: 12px 14px;
      font-size: .82rem;
      color: var(--text);
      line-height: 1.7;
      white-space: pre-wrap;
      min-height: 48px;
    }

    .notice-meta {
      font-size: .68rem;
      color: var(--text-dim);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Admin edit panel */
    .notice-admin-panel {
      border-top: 1px solid var(--border);
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .notice-admin-panel textarea {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: .8rem;
      line-height: 1.6;
      resize: vertical;
      min-height: 72px;
      outline: none;
      transition: border-color .2s;
    }

    .notice-admin-panel textarea:focus {
      border-color: rgba(232, 131, 74, .4);
    }

    .notice-admin-row {
      display: flex;
      gap: 8px;
    }

    .notice-admin-row input {
      flex: 1;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 7px 10px;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: .77rem;
      outline: none;
      transition: border-color .2s;
    }

    .notice-admin-row input:focus {
      border-color: rgba(232, 131, 74, .4);
    }

    .notice-admin-row input::placeholder {
      color: var(--text-dim);
    }

    /* Email register panel */
    .email-register {
      border-top: 1px solid var(--border);
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .email-register-title {
      font-size: .7rem;
      color: var(--text-muted);
      font-weight: 600;
    }

    .email-register-row {
      display: flex;
      gap: 6px;
    }

    .email-register-row input {
      flex: 1;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 7px 10px;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: .77rem;
      outline: none;
    }

    .email-register-row input::placeholder {
      color: var(--text-dim);
    }

    .btn-sm {
      padding: 7px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--glass);
      color: var(--text-muted);
      font-size: .72rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
    }

    .btn-sm:hover {
      background: var(--glass-hover);
      color: var(--text);
      border-color: var(--border-hover);
    }

    .btn-sm.accent {
      background: rgba(240, 192, 74, .1);
      border-color: rgba(240, 192, 74, .25);
      color: var(--accent);
    }

    .btn-sm.accent:hover {
      background: rgba(240, 192, 74, .2);
      border-color: rgba(240, 192, 74, .4);
    }

    .btn-sm.orange {
      background: rgba(232, 131, 74, .12);
      border-color: rgba(232, 131, 74, .3);
      color: var(--accent2);
    }

    .btn-sm.orange:hover {
      background: rgba(232, 131, 74, .22);
    }

    .notice-msg {
      font-size: .7rem;
      min-height: 16px;
    }

    .notice-msg.ok {
      color: var(--sync-ok);
    }

    .notice-msg.err {
      color: #f87171;
    }

    /* Print */
    @media print {

      #setup-screen,
      .header-actions,
      .toast {
        display: none !important;
      }

      body {
        background: #fff !important;
        color: #000 !important;
        background-image: none !important;
      }

      .app-container {
        padding: 0;
      }

      .card {
        background: #fff !important;
        border: 1px solid #ccc !important;
        box-shadow: none !important;
      }

      .card-header {
        border-bottom: 1px solid #ccc !important;
      }

      .card-title {
        color: #333 !important;
      }

      .main-content {
        grid-template-columns: 280px 1fr;
        gap: 12px;
      }

      .priority-item {
        background: #f9f9f9 !important;
        border: 1px solid #ddd !important;
      }

      .priority-input,
      .time-input {
        color: #000 !important;
      }

      .time-label {
        color: #000 !important;
      }

      .time-label.am {
        color: #b8860b !important;
      }

      .time-label.pm {
        color: #c05a00 !important;
      }

      #brain-dump {
        background: #f9f9f9 !important;
        border: 1px solid #ddd !important;
        color: #000 !important;
        background-image: radial-gradient(circle, #ddd 1px, transparent 1px) !important;
        background-size: 18px 18px !important;
      }

      .date-nav {
        background: #f9f9f9 !important;
        border: 1px solid #ddd !important;
      }

      #date-input {
        color: #000 !important;
      }

      .brand-title h1 {
        -webkit-text-fill-color: #b8860b !important;
      }
    }

    @media(max-width:760px) {
      .main-content {
        grid-template-columns: 1fr;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
      }

      .timebox-header,
      .time-row {
        grid-template-columns: 44px 1fr 1fr;
      }

      .time-label {
        font-size: .72rem;
      }
    }

    /* ========== MODAL COMMON ========== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .6);
      z-index: 500;
      backdrop-filter: blur(4px);
    }

    .modal-wrap {
      position: fixed;
      inset: 0;
      z-index: 501;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .modal-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      width: 100%;
      max-width: 520px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
    }

    .modal-head {
      padding: 18px 20px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-head h2 {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text);
    }

    .modal-close {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: none;
      background: var(--glass);
      color: var(--text-muted);
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      background: var(--glass-hover);
      color: var(--text);
    }

    .modal-body {
      padding: 18px 20px;
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      padding: 0 20px 18px;
    }

    /* Tabs */
    .modal-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      padding: 0 20px;
    }

    .modal-tab {
      padding: 10px 14px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-muted);
      font-size: .78rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    .modal-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .modal-tab-content {
      display: none;
      padding: 16px 20px;
    }

    .modal-tab-content.active {
      display: block;
    }

    /* Form */
    .form-label {
      font-size: .72rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 6px;
      display: block;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: .82rem;
      outline: none;
      transition: border-color .2s;
    }

    .form-input:focus {
      border-color: rgba(240, 192, 74, .4);
    }

    .form-input::placeholder {
      color: var(--text-dim);
    }

    .form-row {
      margin-bottom: 14px;
    }

    .form-hint {
      font-size: .68rem;
      color: var(--text-dim);
      margin-top: 5px;
      line-height: 1.5;
    }

    /* Tag input */
    .tag-input-wrap {
      min-height: 48px;
      padding: 6px 8px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      cursor: text;
      transition: border-color .2s;
    }

    .tag-input-wrap:focus-within {
      border-color: rgba(240, 192, 74, .4);
    }

    .tag-chip {
      display: flex;
      align-items: center;
      gap: 5px;
      background: rgba(240, 192, 74, .12);
      border: 1px solid rgba(240, 192, 74, .3);
      border-radius: 5px;
      padding: 3px 8px;
      font-size: .72rem;
      color: var(--accent);
      font-weight: 600;
      white-space: nowrap;
    }

    .tag-chip .tag-x {
      cursor: pointer;
      opacity: .7;
      font-size: .8rem;
      line-height: 1;
    }

    .tag-chip .tag-x:hover {
      opacity: 1;
    }

    .tag-bare-input {
      flex: 1;
      min-width: 160px;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: .8rem;
      padding: 2px 4px;
    }

    .tag-bare-input::placeholder {
      color: var(--text-dim);
    }

    /* Modal msg */
    .modal-msg {
      font-size: .73rem;
      min-height: 18px;
      margin-top: 8px;
    }

    .modal-msg.ok {
      color: var(--sync-ok);
    }

    .modal-msg.err {
      color: #f87171;
    }

    /* Share modal */
    .share-date-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 12px;
      background: rgba(240, 192, 74, .1);
      border: 1px solid rgba(240, 192, 74, .2);
      border-radius: 20px;
      font-size: .78rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 12px;
    }

    .share-info {
      font-size: .72rem;
      color: var(--text-dim);
      margin: 8px 0 0;
      line-height: 1.5;
    }

    /* PWA install banner */
    .pwa-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      z-index: 300;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, .3);
    }

    .pwa-banner-text {
      font-size: .8rem;
      color: var(--text);
    }

    .pwa-banner-text strong {
      color: var(--accent);
    }

    .pwa-banner-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
  </style>
</head>

<body>

  <!-- ===================== SETUP WIZARD ===================== -->
  <div id="setup-screen" style="display:none;">
    <div class="setup-card">
      <div class="setup-logo">God's<br>Love</div>
      <h2>ì²˜ìŒ ì˜¤ì…¨êµ°ìš”! ğŸ‘‹</h2>
      <p>Google Sheetsì™€ ì—°ê²°í•˜ë©´ PCÂ·í•¸ë“œí° ì–´ë””ì„œë“  ê°™ì€ ë°ì´í„°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
        ì•„ë˜ 3ë‹¨ê³„ë¥¼ ë”°ë¼ ì„¤ì •í•˜ì„¸ìš”. (ì•½ 5ë¶„ ì†Œìš”)</p>
      <ol class="setup-steps">
        <li><span class="step-num">1</span>
          <span><strong>script.google.com</strong> â†’ ìƒˆ í”„ë¡œì íŠ¸ â†’ ê¸°ì¡´ ì½”ë“œ ì „ì²´ ì‚­ì œ<br>
            â†’ <code>PlannerAPI.gs</code> íŒŒì¼ ë‚´ìš© ë¶™ì—¬ë„£ê¸° â†’ ì €ì¥</span>
        </li>
        <li><span class="step-num">2</span>
          <span><strong>ë°°í¬ â†’ ìƒˆ ë°°í¬</strong> â†’ ìœ í˜•: ì›¹ì•± â†’ ì•¡ì„¸ìŠ¤: <strong>ëª¨ë“  ì‚¬ìš©ì</strong> â†’ ë°°í¬ â†’ URL ë³µì‚¬</span>
        </li>
        <li><span class="step-num">3</span>
          <span>ì•„ë˜ì— ë³µì‚¬í•œ <strong>ì›¹ ì•± URL</strong> ë¶™ì—¬ë„£ê¸° â†’ ì—°ê²° í…ŒìŠ¤íŠ¸ â†’ ì‹œì‘!</span>
        </li>
      </ol>
      <div class="setup-input-wrap">
        <input type="url" id="script-url-input" placeholder="https://script.google.com/macros/s/â€¦/exec" />
      </div>
      <div class="setup-actions">
        <button class="setup-btn primary" id="setup-test-btn">ğŸ”— ì—°ê²° í…ŒìŠ¤íŠ¸</button>
        <button class="setup-btn primary" id="setup-save-btn" style="display:none;">âœ“ ì €ì¥í•˜ê³  ì‹œì‘</button>
      </div>
      <div class="setup-msg" id="setup-msg"></div>
      <div class="setup-skip">
        <a id="setup-skip-btn">Google Sheets ì—†ì´ ì‚¬ìš©í•˜ê¸° (ì´ ê¸°ê¸°ë§Œ ì €ì¥ë¨)</a>
      </div>
    </div>
  </div>

  <!-- ===================== PLANNER APP ===================== -->
  <div class="app-container" id="planner-app" style="display:none;">

    <div class="header">
      <div class="header-brand">
        <div class="brand-logo">God's<br>Love</div>
        <div class="brand-title">
          <h1>King's Planner</h1>
          <span>With King of kings</span>
        </div>
      </div>

      <div class="date-nav">
        <button class="date-btn" id="prev-day">â€¹</button>
        <div class="date-display">
          <input type="date" id="date-input" />
          <div id="date-weekday"></div>
        </div>
        <button class="date-btn" id="next-day">â€º</button>
        <button class="today-btn" id="today-btn">ì˜¤ëŠ˜</button>
      </div>

      <div class="header-actions">
        <!-- Sync badge -->
        <div class="sync-badge no-sync" id="sync-badge" title="í´ë¦­í•˜ë©´ ì§€ê¸ˆ ë™ê¸°í™”" style="cursor:pointer;" id="sync-badge">
          <div class="sync-dot"></div>
          <span id="sync-label">ì˜¤í”„ë¼ì¸</span>
        </div>
        <!-- Theme toggle -->
        <button class="theme-toggle" id="theme-toggle">
          <span id="theme-label">â˜€ï¸ í™”ì´íŠ¸</span>
          <div class="toggle-track">
            <div class="toggle-thumb"></div>
          </div>
        </button>
        <button class="action-btn" id="share-btn">ğŸ“¤ ê³µìœ </button>
        <button class="action-btn primary" id="print-btn">ğŸ–¨ï¸ ì¸ì‡„</button>
        <button class="action-btn" id="clear-btn">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
        <button class="icon-btn" id="settings-btn" title="ì„¤ì •">âš™ï¸</button>
      </div>
    </div>

    <div class="main-content">
      <div class="left-panel">
        <div class="card">
          <div class="card-header">
            <span class="card-title">Top Priorities</span>
            <span class="card-badge" id="priority-badge">0 / 3</span>
          </div>
          <div class="priorities-list" id="priorities-list"></div>
          <div class="progress-bar-wrap">
            <div class="progress-label">
              <span>ì˜¤ëŠ˜ì˜ ì§„í–‰ë¥ </span>
              <span id="progress-pct">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill"></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Brain Dump</span>
            <span style="font-size:.68rem;color:var(--text-muted)">ììœ ë¡­ê²Œ ìŸì•„ë‚´ê¸°</span>
          </div>
          <div class="brain-dump-body">
            <textarea id="brain-dump" placeholder="ë¨¸ë¦¿ì†ì— ìˆëŠ” ê²ƒë“¤ì„ ì „ë¶€ ì ì–´ë³´ì„¸ìš”.&#10;ì•„ì´ë””ì–´, ê±±ì •, í•  ì¼, ë– ì˜¤ë¥´ëŠ” ìƒê°..."></textarea>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><span class="card-title">ì˜¤ëŠ˜ì˜ í˜„í™©</span></div>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-label">ì±„ì›Œì§„ ì‹œê°„</div>
              <div class="stat-value accent" id="stat-filled">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">ë¹ˆ ìŠ¬ë¡¯</div>
              <div class="stat-value" id="stat-empty">38</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">AM ë¸”ë¡</div>
              <div class="stat-value accent" id="stat-am">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">PM ë¸”ë¡</div>
              <div class="stat-value accent2" id="stat-pm">0</div>
            </div>
          </div>
        </div>

        <!-- ì˜¤ëŠ˜ì˜ ê³µì§€ ì¹´ë“œ -->
        <div class="card notice-card" id="notice-card">
          <div class="card-header">
            <span class="card-title" style="display:flex;align-items:center;gap:7px;">
              <span class="notice-dot" id="notice-dot" style="display:none;"></span>
              ì˜¤ëŠ˜ì˜ ê³µì§€
            </span>
          </div>

          <div class="notice-list-container" id="notice-list-container"
            style="padding: 14px 16px; display: flex; flex-direction: column; gap: 10px;">
            <div class="notice-text">ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
          </div>

          <!-- ì´ë©”ì¼ ì•Œë¦¼ ë“±ë¡ -->
          <div class="email-register" id="email-register-panel">
            <div class="email-register-title">ğŸ“§ ê³µì§€ ì´ë©”ì¼ ì•Œë¦¼ ë°›ê¸° (Gmail)</div>
            <div class="email-register-row">
              <input type="email" id="user-email-input" placeholder="ë‚´ Gmail ì£¼ì†Œ" />
              <button class="btn-sm accent" id="email-register-btn">ë“±ë¡</button>
            </div>
            <div class="notice-msg" id="email-register-msg"></div>
          </div>
        </div>

      </div>

      <div class="right-panel">
        <div class="card">
          <div class="timebox-header">
            <span class="card-title" style="font-size:.85rem;">ì‹œê°„</span>
            <span class="time-col-label">: 00</span>
            <span class="time-col-label">: 30</span>
          </div>
          <div id="timebox-body"></div>
        </div>
      </div>
    </div>

    <div class="footer">âœ¦ ëª¨ë“  ë°ì´í„°ëŠ” ìë™ ì €ì¥ë©ë‹ˆë‹¤ &nbsp;Â·&nbsp; King's Planner by GOD's LOVE</div>
  </div>

  <div class="toast" id="toast"><span>âœ“</span><span id="toast-msg">ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</span></div>

  <!-- ===== SETTINGS MODAL ===== -->
  <div id="settings-modal" style="display:none;">
    <div class="modal-overlay" id="settings-overlay"></div>
    <div class="modal-wrap">
      <div class="modal-card">
        <div class="modal-head">
          <h2>âš™ï¸ ì„¤ì •</h2>
          <button class="modal-close" id="settings-modal-close">Ã—</button>
        </div>
        <div class="modal-tabs">
          <button class="modal-tab active" data-tab="conn">ğŸ”— ì—°ê²°</button>
          <button class="modal-tab" data-tab="acct">ğŸ‘¤ ë‚´ ê³„ì •</button>
        </div>
        <!-- ì—°ê²° íƒ­ -->
        <div class="modal-tab-content active" id="tab-conn">
          <div class="form-row">
            <label class="form-label">Apps Script ì›¹ì•± URL</label>
            <input class="form-input" id="cfg-url" type="url" placeholder="https://script.google.com/macros/s/â€¦/exec" />
            <div class="form-hint">ë³€ê²½ í›„ ë°˜ë“œì‹œ ì—°ê²° í…ŒìŠ¤íŠ¸ë¥¼ í•´ì£¼ì„¸ìš”.</div>
          </div>
          <div style="display:flex;gap:8px;">
            <button class="btn-sm accent" id="cfg-test-btn">ğŸ”— ì—°ê²° í…ŒìŠ¤íŠ¸</button>
            <button class="btn-sm orange" id="cfg-save-url-btn">ì €ì¥</button>
          </div>
          <div class="modal-msg" id="cfg-url-msg"></div>
        </div>
        <!-- ê³„ì • íƒ­ -->
        <div class="modal-tab-content" id="tab-acct">
          <div class="form-row">
            <label class="form-label">ë‚´ ì´ë¦„</label>
            <input class="form-input" id="cfg-name" type="text" placeholder="í™ê¸¸ë™" />
          </div>
          <div class="form-row">
            <label class="form-label">ë‚´ Gmail ì£¼ì†Œ</label>
            <input class="form-input" id="cfg-email" type="email" placeholder="me@gmail.com" />
            <div class="form-hint">ê³µì§€ ì•Œë¦¼ ìˆ˜ì‹  ë° ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ì— ì‚¬ìš©ë©ë‹ˆë‹¤.</div>
          </div>
          <button class="btn-sm accent" id="cfg-acct-save-btn">ğŸ’¾ ì €ì¥ ë° ë“±ë¡</button>
          <div class="modal-msg" id="cfg-acct-msg"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== SHARE MODAL ===== -->
  <div id="share-modal" style="display:none;">
    <div class="modal-overlay" id="share-overlay"></div>
    <div class="modal-wrap">
      <div class="modal-card">
        <div class="modal-head">
          <h2>ğŸ“¤ ë‚´ ì¼ì • ê³µìœ í•˜ê¸°</h2>
          <button class="modal-close" id="share-modal-close">Ã—</button>
        </div>
        <div class="modal-body">
          <div class="share-date-pill">ğŸ“… <span id="share-date-label"></span></div>
          <label class="form-label">ë°›ëŠ” ì‚¬ëŒ (Gmail ì£¼ì†Œ, Enterë¡œ ì¶”ê°€)</label>
          <div class="tag-input-wrap" id="share-tag-wrap">
            <input class="tag-bare-input" id="share-tag-input" type="email" placeholder="email@gmail.com ì…ë ¥ í›„ Enter" />
          </div>
          <p class="share-info">ê³µìœ  ë‚´ìš©: ìš°ì„ ìˆœìœ„ Â· ì‹œê°„ ë¸”ë¡ <br>â€» Brain Dump ë° ê³µì§€ì‚¬í•­ì€ ê³µìœ ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.</p>
          <div class="modal-msg" id="share-msg"></div>
        </div>
        <div class="modal-actions">
          <button class="btn-sm orange" id="share-send-btn" style="flex:1;padding:10px;">ğŸ“¤ ê³µìœ í•˜ê¸°</button>
          <button class="btn-sm" id="share-cancel-btn" style="flex:1;padding:10px;">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== PWA ì„¤ì¹˜ ë°°ë„ˆ ===== -->
  <div class="pwa-banner" id="pwa-banner" style="display:none;">
    <div class="pwa-banner-text">ğŸ“± <strong>King's Planner</strong> ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ë©´ ë” í¸ë¦¬í•©ë‹ˆë‹¤!</div>
    <div class="pwa-banner-actions">
      <button class="btn-sm accent" id="pwa-install-btn">ì„¤ì¹˜</button>
      <button class="btn-sm" id="pwa-dismiss-btn">ë‹«ê¸°</button>
    </div>
  </div>

  <script>
    /* ============================================================
       CONSTANTS
    ============================================================ */
    const WEEKDAYS = ['ì¼ìš”ì¼', 'ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼'];
    const HOURS = [];
    for (let h = 5; h <= 23; h++) HOURS.push(h);
    const TIME_KEYS = [];
    HOURS.forEach(h => { TIME_KEYS.push(`t${h}_0`); TIME_KEYS.push(`t${h}_30`); });

    /* ============================================================
       STATE
    ============================================================ */
    let currentDate = todayStr();
    let scriptUrl = localStorage.getItem('planner_script_url') || '';
    let isSyncing = false;
    let pendingPush = null; // setTimeout id

    /* ============================================================
       UTILS
    ============================================================ */
    function todayStr() {
      const d = new Date();
      return `${d.getFullYear()}-${p2(d.getMonth() + 1)}-${p2(d.getDate())}`;
    }
    function p2(n) { return String(n).padStart(2, '0'); }
    function localKey(date) { return `timebox_${date}`; }
    function loadLocal(date) { try { return JSON.parse(localStorage.getItem(localKey(date))) || {}; } catch { return {}; } }
    function saveLocal(date, data) { localStorage.setItem(localKey(date), JSON.stringify(data)); }

    function showToast(msg) {
      document.getElementById('toast-msg').textContent = msg;
      const t = document.getElementById('toast');
      t.classList.add('show');
      clearTimeout(window._tt);
      window._tt = setTimeout(() => t.classList.remove('show'), 2200);
    }

    function getWeekday(ds) {
      const [y, m, d] = ds.split('-').map(Number);
      return WEEKDAYS[new Date(y, m - 1, d).getDay()];
    }
    function shiftDate(ds, days) {
      const [y, m, d] = ds.split('-').map(Number);
      const dt = new Date(y, m - 1, d + days);
      return `${dt.getFullYear()}-${p2(dt.getMonth() + 1)}-${p2(dt.getDate())}`;
    }
    function hourLabel(h) {
      if (h === 12) return { label: '12', cls: 'noon' };
      return h < 12 ? { label: String(h), cls: 'am' } : { label: String(h - 12), cls: 'pm' };
    }
    function isAM(h) { return h < 12; }

    /* ============================================================
       SYNC STATUS
    ============================================================ */
    function setSyncStatus(state, msg) {
      const badge = document.getElementById('sync-badge');
      const label = document.getElementById('sync-label');
      badge.className = 'sync-badge ' + state;
      label.textContent = msg;
    }

    /* ============================================================
       GOOGLE SHEETS SYNC
    ============================================================ */
    async function pullFromSheets(date, quiet) {
      if (!scriptUrl) return null;
      try {
        if (!quiet) setSyncStatus('busy', 'ë™ê¸°í™” ì¤‘â€¦');
        const url = `${scriptUrl}?date=${date}&_=${Date.now()}`;
        const res = await fetch(url, { method: 'GET' });
        const json = await res.json();
        if (json.error || !json.exists) { setSyncStatus('ok', 'âœ“ ì—°ê²°ë¨'); return null; }
        setSyncStatus('ok', 'âœ“ ì—°ê²°ë¨');
        return json;
      } catch (e) {
        setSyncStatus('off', 'âš¡ ì˜¤í”„ë¼ì¸');
        return null;
      }
    }

    async function pushToSheets(date, data) {
      if (!scriptUrl) return;
      isSyncing = true;
      setSyncStatus('busy', 'ì €ì¥ ì¤‘â€¦');
      try {
        const payload = { action: 'savePlanner', date, ...data };
        await fetch(scriptUrl, {
          method: 'POST',
          body: JSON.stringify(payload),
          headers: { 'Content-Type': 'text/plain' }
        });
        setSyncStatus('ok', 'âœ“ ë™ê¸°í™”ë¨');
      } catch (e) {
        setSyncStatus('off', 'âš¡ ì˜¤í”„ë¼ì¸');
      }
      isSyncing = false;
    }

    /* ============================================================
       BUILD DOM
    ============================================================ */
    function buildPriorities() {
      const c = document.getElementById('priorities-list');
      c.innerHTML = '';
      for (let i = 0; i < 3; i++) {
        const item = document.createElement('div');
        item.className = 'priority-item'; item.dataset.idx = i;
        item.innerHTML = `
      <div class="priority-num">${i + 1}</div>
      <textarea class="priority-input" id="priority-${i}" rows="2" placeholder="ì˜¤ëŠ˜ì˜ ìµœìš°ì„  ê³¼ì œ ${i + 1}..."></textarea>
      <div class="priority-check" id="priority-check-${i}" data-idx="${i}"></div>`;
        c.appendChild(item);
        item.querySelector('.priority-input').addEventListener('input', onInput);
        item.querySelector('.priority-check').addEventListener('click', onPriorityCheck);
      }
    }

    function buildTimeblocks() {
      const body = document.getElementById('timebox-body');
      body.innerHTML = '';
      HOURS.forEach(h => {
        [0, 30].forEach(min => {
          const row = document.createElement('div');
          const { label, cls } = hourLabel(h);
          row.className = `time-row ${isAM(h) ? 'am-row' : 'pm-row'}`;
          row.dataset.h = h; row.dataset.min = min;

          const tl = document.createElement('div');
          tl.className = `time-label ${cls}`;
          tl.innerHTML = min === 0 ? label : `<span style="color:var(--text-dim);font-size:.65rem;font-weight:500">:30</span>`;

          const cell = document.createElement('div');
          cell.className = 'time-input-cell';
          const inp = document.createElement('input');
          inp.type = 'text'; inp.className = 'time-input';
          inp.id = `time_${h}_${min}`; inp.dataset.h = h; inp.dataset.min = min;
          inp.addEventListener('input', onTimeInput);
          inp.addEventListener('focus', () => row.style.background = 'var(--glass-hover)');
          inp.addEventListener('blur', () => row.style.background = '');
          cell.appendChild(inp);

          const cell2 = document.createElement('div');
          cell2.className = 'time-input-cell';

          row.appendChild(tl); row.appendChild(cell); row.appendChild(cell2);
          body.appendChild(row);
        });
      });
    }

    /* ============================================================
       LOAD / SAVE PAGE
    ============================================================ */
    function applyData(data) {
      for (let i = 0; i < 3; i++) {
        const inp = document.getElementById(`priority-${i}`);
        const chk = document.getElementById(`priority-check-${i}`);
        const item = document.querySelector(`.priority-item[data-idx="${i}"]`);
        inp.value = data[`p${i}`] || '';
        const checked = data[`pc${i}`] === true || data[`pc${i}`] === 'TRUE';
        chk.classList.toggle('checked', checked);
        item.classList.toggle('completed', checked);
      }
      document.getElementById('brain-dump').value = data.brainDump || '';
      HOURS.forEach(h => {
        [0, 30].forEach(min => {
          const inp = document.getElementById(`time_${h}_${min}`);
          if (inp) { const v = data[`t${h}_${min}`] || ''; inp.value = v; inp.classList.toggle('has-content', !!v); }
        });
      });
      updateStats(); updateProgress();
    }

    // â˜… ë°ì´í„°ê°€ ì™„ì „íˆ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
    function isDataEmpty(d) {
      if (!d) return true;
      if (d.brainDump && d.brainDump.trim()) return false;
      for (let i = 0; i < 3; i++) {
        if (d[`p${i}`] && d[`p${i}`].trim()) return false;
        if (d[`pc${i}`] === true || d[`pc${i}`] === 'TRUE') return false;
      }
      for (let key in d) {
        if (key.startsWith('t') && d[key] && String(d[key]).trim()) return false;
      }
      return true;
    }

    // â˜… Sheets ë°ì´í„° ì‚¬ìš© ì—¬ë¶€ íŒì • (íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë°˜)
    function shouldUseRemote(remote, local) {
      if (!remote) return false;
      const remoteEmpty = isDataEmpty(remote);
      const localEmpty = isDataEmpty(local);

      // 1. ë§Œì•½ ë¡œì»¬ì€ í…… ë¹„ì—ˆê³  Sheetsì—ëŠ” ë‚´ìš©ì´ ìˆë‹¤ë©´ â†’ ë¬´ì¡°ê±´ Sheets ë³´ì¡´
      if (localEmpty && !remoteEmpty) return true;

      const hasR = !!remote.lastModified;
      const hasL = !!local._localModified;
      if (!hasR && !hasL) return true;   // ë‘˜ ë‹¤ íƒ€ì„ìŠ¤íƒ¬í”„ ì—†ìŒ â†’ Sheets ì‹ ë¢° (ì´ˆê¸° ë¡œë“œ)
      if (hasR && !hasL) return true;   // Sheetsë§Œ íƒ€ì„ìŠ¤íƒ¬í”„ ìˆìŒ â†’ Sheets ì‹ ë¢°
      if (!hasR && hasL) return false;  // ë¡œì»¬ë§Œ íƒ€ì„ìŠ¤íƒ¬í”„ ìˆìŒ â†’ ë¡œì»¬ ì‹ ë¢° (â˜… í•µì‹¬ ìˆ˜ì •)
      // ë‘˜ ë‹¤ íƒ€ì„ìŠ¤íƒ¬í”„ ìˆìŒ â†’ ìµœì‹  ë¹„êµ
      const rt = new Date(remote.lastModified.replace(' ', 'T') + '+09:00');
      const lt = new Date(local._localModified);
      return rt >= lt;
    }

    async function loadPage(date) {
      const local = loadLocal(date);
      applyData(local);
      const remote = await pullFromSheets(date);
      if (shouldUseRemote(remote, local)) {
        saveLocal(date, remote);
        applyData(remote);
      } else if (remote && !isDataEmpty(local)) {
        // ë¡œì»¬ì´ ë” ìµœì‹ ì´ê³  í…… ë¹„ì–´ìˆì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ë¡œì»¬ì„ Sheetsì— push
        clearTimeout(pendingPush);
        pushToSheets(date, local);
      }
    }

    function collectData() {
      const d = {};
      for (let i = 0; i < 3; i++) {
        d[`p${i}`] = document.getElementById(`priority-${i}`).value;
        d[`pc${i}`] = document.getElementById(`priority-check-${i}`).classList.contains('checked');
      }
      d.brainDump = document.getElementById('brain-dump').value;
      HOURS.forEach(h => {
        [0, 30].forEach(min => {
          const inp = document.getElementById(`time_${h}_${min}`);
          if (inp) d[`t${h}_${min}`] = inp.value;
        });
      });
      return d;
    }

    let lastLocalActivity = 0; // ë§ˆì§€ë§‰ ì…ë ¥ ì‹œê° (ì ì‘í˜• í´ë§ ì‚¬ìš©)

    function scheduleSave() {
      const date = currentDate;
      const data = collectData();
      data._localModified = new Date().toISOString();
      lastLocalActivity = Date.now();
      saveLocal(date, data);
      clearTimeout(pendingPush);
      pendingPush = setTimeout(() => pushToSheets(date, data), 1000); // 1ì´ˆ ë””ë°”ìš´ìŠ¤ (ì¦ì‹œ push)
    }

    /* ============================================================
       STATS / PROGRESS
    ============================================================ */
    function updateStats() {
      let filled = 0, am = 0, pm = 0; const total = HOURS.length * 2;
      HOURS.forEach(h => {
        [0, 30].forEach(min => {
          const inp = document.getElementById(`time_${h}_${min}`);
          if (inp && inp.value.trim()) { filled++; isAM(h) ? am++ : pm++; }
        });
      });
      document.getElementById('stat-filled').textContent = filled;
      document.getElementById('stat-empty').textContent = total - filled;
      document.getElementById('stat-am').textContent = am;
      document.getElementById('stat-pm').textContent = pm;
    }
    function updateProgress() {
      let checked = 0;
      for (let i = 0; i < 3; i++) if (document.getElementById(`priority-check-${i}`).classList.contains('checked')) checked++;
      const pct = Math.round((checked / 3) * 100);
      document.getElementById('priority-badge').textContent = `${checked} / 3`;
      document.getElementById('progress-pct').textContent = `${pct}%`;
      document.getElementById('progress-fill').style.width = `${pct}%`;
    }

    /* ============================================================
       EVENT HANDLERS
    ============================================================ */
    function onInput() { scheduleSave(); }
    function onPriorityCheck(e) {
      const idx = e.currentTarget.dataset.idx;
      const chk = document.getElementById(`priority-check-${idx}`);
      const item = document.querySelector(`.priority-item[data-idx="${idx}"]`);
      chk.classList.toggle('checked'); item.classList.toggle('completed', chk.classList.contains('checked'));
      updateProgress(); scheduleSave();
    }
    function onTimeInput(e) {
      e.target.classList.toggle('has-content', !!e.target.value.trim());
      updateStats(); scheduleSave();
    }
    const brainDumpEl = document.getElementById('brain-dump');
    brainDumpEl.addEventListener('input', scheduleSave);
    brainDumpEl.addEventListener('focus', function () {
      if (this.value === '') {
        this.value = 'â€¢ ';
      }
    });
    brainDumpEl.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const start = this.selectionStart;
        const end = this.selectionEnd;
        const text = this.value;
        this.value = text.substring(0, start) + '\nâ€¢ ' + text.substring(end);
        this.selectionStart = this.selectionEnd = start + 3;
        scheduleSave();
      }
    });

    /* Date nav */
    function setDate(date) {
      // save current first
      const data = collectData(); saveLocal(currentDate, data);
      clearTimeout(pendingPush);
      if (scriptUrl) pushToSheets(currentDate, data);
      currentDate = date;
      document.getElementById('date-input').value = date;
      document.getElementById('date-weekday').textContent = getWeekday(date);
      loadPage(date);
    }
    document.getElementById('date-input').addEventListener('change', e => setDate(e.target.value));
    document.getElementById('prev-day').addEventListener('click', () => setDate(shiftDate(currentDate, -1)));
    document.getElementById('next-day').addEventListener('click', () => setDate(shiftDate(currentDate, 1)));
    document.getElementById('today-btn').addEventListener('click', () => setDate(todayStr()));
    document.getElementById('print-btn').addEventListener('click', () => { const d = collectData(); saveLocal(currentDate, d); window.print(); });
    document.getElementById('clear-btn').addEventListener('click', () => {
      if (!confirm('ì˜¤ëŠ˜ í•˜ë£¨ì˜ ëª¨ë“  ë‚´ìš©ì„ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
      localStorage.removeItem(localKey(currentDate));
      applyData({}); updateStats(); updateProgress();
      showToast('ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
    });

    // ğŸ”„ ìˆ˜ë™ ë™ê¸°í™” â€” sync badge í´ë¦­
    document.getElementById('sync-badge').addEventListener('click', async () => {
      if (!scriptUrl) { showToast('ë¨¼ì € Google Sheetsë¥¼ ì—°ê²°í•˜ì„¸ìš” (âš™ï¸)'); return; }
      showToast('ğŸ”„ ë™ê¸°í™” ì¤‘...');
      const local = loadLocal(currentDate);
      const remote = await pullFromSheets(currentDate);
      if (shouldUseRemote(remote, local)) {
        saveLocal(currentDate, remote); applyData(remote); updateStats(); updateProgress();
        showToast('âœ“ Sheets ìµœì‹  ë°ì´í„°ë¡œ ë™ê¸°í™”ë¨');
      } else if (remote && !isDataEmpty(local)) {
        const data = collectData();
        data._localModified = local._localModified;
        clearTimeout(pendingPush);
        pushToSheets(currentDate, data);
        showToast('ğŸ“¤ ë¡œì»¬ ìµœì‹  ë°ì´í„°ë¥¼ Sheetsì— ì—…ë¡œë“œ');
      } else {
        showToast('âœ“ ì´ ë‚ ì§œ Sheets ë°ì´í„° ì—†ìŒ (ë¡œì»¬ ìœ ì§€)');
      }
    });

    // â±ï¸ ì ì‘í˜• ìë™ ë™ê¸°í™” (í™œì„±: 30ì´ˆ / íœ´ì‹: 5ë¶„)
    let lastAutoPull = 0;
    setInterval(async () => {
      if (!scriptUrl || isSyncing) return;
      const now = Date.now();
      const isActive = (now - lastLocalActivity) < 10 * 60 * 1000;
      const interval = isActive ? 30 * 1000 : 5 * 60 * 1000;
      if ((now - lastAutoPull) < interval) return;
      lastAutoPull = now;
      const local = loadLocal(currentDate);
      const remote = await pullFromSheets(currentDate, true);
      if (shouldUseRemote(remote, local)) {
        saveLocal(currentDate, remote);
        applyData(remote); updateStats(); updateProgress();
        setSyncStatus('ok', 'âœ“ ë™ê¸°í™”ë¨');
      } else if (remote && !isDataEmpty(local)) {
        const data = collectData();
        data._localModified = local._localModified;
        pushToSheets(currentDate, data);
      }
    }, 30 * 1000);

    // ğŸ“² ëª¨ë°”ì¼ì—ì„œ ì•±ìœ¼ë¡œ ëŒì•„ì˜¬ ë•Œ ìë™ ë™ê¸°í™”
    async function syncOnFocus() {
      if (!scriptUrl) return;
      lastAutoPull = 0;
      const local = loadLocal(currentDate);
      const remote = await pullFromSheets(currentDate, true);
      if (shouldUseRemote(remote, local)) {
        saveLocal(currentDate, remote);
        applyData(remote); updateStats(); updateProgress();
        setSyncStatus('ok', 'âœ“ ë™ê¸°í™”ë¨');
      } else if (remote && !isDataEmpty(local)) {
        const data = collectData();
        data._localModified = local._localModified;
        pushToSheets(currentDate, data);
      }
    }
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') syncOnFocus();
    });
    window.addEventListener('pageshow', (e) => {
      if (e.persisted) syncOnFocus();
    });
    window.addEventListener('focus', () => syncOnFocus());

    /* Settings btn â†’ handled by openSettingsModal() below */

    /* ============================================================
       THEME
    ============================================================ */
    function applyTheme(isWhite) {
      document.body.classList.toggle('white-mode', isWhite);
      document.getElementById('theme-label').textContent = isWhite ? 'ğŸŒ™ ë‹¤í¬' : 'â˜€ï¸ í™”ì´íŠ¸';
      localStorage.setItem('timebox_theme', isWhite ? 'white' : 'dark');
    }
    document.getElementById('theme-toggle').addEventListener('click', () => {
      applyTheme(!document.body.classList.contains('white-mode'));
    });

    /* ============================================================
       SETUP WIZARD
    ============================================================ */
    function openSetup() {
      document.getElementById('planner-app').style.display = 'none';
      document.getElementById('setup-screen').style.display = 'flex';
      document.getElementById('script-url-input').value = scriptUrl || '';
      document.getElementById('setup-msg').textContent = '';
      document.getElementById('setup-save-btn').style.display = 'none';
      document.getElementById('setup-test-btn').style.display = 'inline-block';
    }

    function closeSetup() {
      document.getElementById('setup-screen').style.display = 'none';
      document.getElementById('planner-app').style.display = 'block';
    }

    document.getElementById('setup-test-btn').addEventListener('click', async () => {
      const url = document.getElementById('script-url-input').value.trim();
      if (!url) { setSetupMsg('URLì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.', 'err'); return; }
      if (!url.startsWith('https://script.google.com')) { setSetupMsg('ì˜¬ë°”ë¥¸ Apps Script URLì´ ì•„ë‹™ë‹ˆë‹¤.', 'err'); return; }
      setSetupMsg('ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘â€¦', '');
      try {
        const res = await fetch(`${url}?date=test&_=${Date.now()}`);
        const json = await res.json();
        if (json.error && !json.exists && json.error !== undefined) throw new Error(json.error);
        setSetupMsg('âœ… ì—°ê²° ì„±ê³µ! ì €ì¥í•˜ê³  ì‹œì‘í•˜ì„¸ìš”.', 'ok');
        document.getElementById('setup-save-btn').style.display = 'inline-block';
        document.getElementById('setup-test-btn').style.display = 'none';
        document.getElementById('setup-save-btn').dataset.url = url;
      } catch (e) {
        setSetupMsg('âŒ ì—°ê²° ì‹¤íŒ¨. URLì„ í™•ì¸í•˜ê±°ë‚˜ ë°°í¬ ì„¤ì •ì„ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.', 'err');
      }
    });

    document.getElementById('setup-save-btn').addEventListener('click', () => {
      const url = document.getElementById('setup-save-btn').dataset.url;
      scriptUrl = url; localStorage.setItem('planner_script_url', url);
      setSyncStatus('ok', 'âœ“ ë™ê¸°í™”ë¨');
      document.getElementById('sync-badge').classList.remove('no-sync');
      closeSetup(); loadPage(currentDate);
      showToast('Google Sheets ì—°ê²° ì™„ë£Œ!');
    });

    document.getElementById('setup-skip-btn').addEventListener('click', () => {
      scriptUrl = ''; localStorage.removeItem('planner_script_url');
      setSyncStatus('off', 'ì˜¤í”„ë¼ì¸ ëª¨ë“œ');
      document.getElementById('sync-badge').classList.add('no-sync');
      closeSetup();
    });

    function setSetupMsg(msg, cls) {
      const el = document.getElementById('setup-msg');
      el.textContent = msg; el.className = 'setup-msg ' + cls;
    }

    /* ============================================================
       PWA â€” Service Worker ë“±ë¡
    ============================================================ */
    let deferredPwaPrompt = null;
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(() => { });
      });
    }
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault(); deferredPwaPrompt = e;
      if (!localStorage.getItem('pwa_dismissed')) {
        document.getElementById('pwa-banner').style.display = 'flex';
      }
    });
    // PWA ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ â€” DOMContentLoaded í›„ ëª¨ë‹¬ HTMLì´ íŒŒì‹±ëœ ë‹¤ìŒ ì‹¤í–‰
    window.addEventListener('DOMContentLoaded', () => {
      const installBtn = document.getElementById('pwa-install-btn');
      const dismissBtn = document.getElementById('pwa-dismiss-btn');
      if (installBtn) installBtn.addEventListener('click', () => {
        if (deferredPwaPrompt) { deferredPwaPrompt.prompt(); deferredPwaPrompt = null; }
        document.getElementById('pwa-banner').style.display = 'none';
      });
      if (dismissBtn) dismissBtn.addEventListener('click', () => {
        document.getElementById('pwa-banner').style.display = 'none';
        localStorage.setItem('pwa_dismissed', '1');
      });
    });

    /* ============================================================
       TAG INPUT HELPER
    ============================================================ */
    function makeTagInput(wrapId, inputId) {
      const emails = [];
      const wrap = document.getElementById(wrapId);
      const inp = document.getElementById(inputId);
      wrap.addEventListener('click', () => inp.focus());
      function addTag(val) {
        val = val.trim().toLowerCase();
        if (!val || !val.includes('@') || emails.includes(val)) return;
        emails.push(val);
        const chip = document.createElement('div');
        chip.className = 'tag-chip';
        chip.innerHTML = `<span>${val}</span><span class="tag-x" data-email="${val}">Ã—</span>`;
        chip.querySelector('.tag-x').addEventListener('click', e => {
          const em = e.target.dataset.email;
          emails.splice(emails.indexOf(em), 1);
          chip.remove();
        });
        wrap.insertBefore(chip, inp);
        inp.value = '';
      }
      inp.addEventListener('keydown', e => {
        if ((e.key === 'Enter' || e.key === ',') && inp.value.trim()) {
          e.preventDefault(); addTag(inp.value);
        }
        if (e.key === 'Backspace' && !inp.value && emails.length) {
          const last = emails[emails.length - 1];
          wrap.querySelectorAll('.tag-chip').forEach(c => {
            if (c.querySelector('.tag-x').dataset.email === last) c.remove();
          });
          emails.pop();
        }
      });
      inp.addEventListener('blur', () => { if (inp.value.trim()) addTag(inp.value); });
      return {
        getEmails: () => [...emails], setEmails: (arr) => {
          wrap.querySelectorAll('.tag-chip').forEach(c => c.remove());
          emails.length = 0; arr.forEach(addTag);
        }
      };
    }

    // Lazy-initialized tag controllers (DOM not yet available at script parse time)
    let shareTagCtrl = null;
    function getShareTagCtrl() {
      if (!shareTagCtrl && document.getElementById('share-tag-wrap')) {
        shareTagCtrl = makeTagInput('share-tag-wrap', 'share-tag-input');
      }
      return shareTagCtrl;
    }

    /* ============================================================
       SETTINGS MODAL
    ============================================================ */
    function openSettingsModal() {
      document.getElementById('settings-modal').style.display = 'block';
      document.getElementById('cfg-url').value = scriptUrl || '';
      document.getElementById('cfg-name').value = localStorage.getItem('planner_name') || '';
      document.getElementById('cfg-email').value = localStorage.getItem('planner_email') || '';
    }
    function closeSettingsModal() {
      document.getElementById('settings-modal').style.display = 'none';
    }
    // Override âš™ï¸ to open settings modal instead of setup wizard
    document.getElementById('settings-btn').addEventListener('click', openSettingsModal);
    document.getElementById('settings-modal-close').addEventListener('click', closeSettingsModal);
    document.getElementById('settings-overlay').addEventListener('click', closeSettingsModal);

    // Tab switching
    document.querySelectorAll('.modal-tab').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        document.querySelectorAll('.modal-tab').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.modal-tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + tab).classList.add('active');
      });
    });

    // ì—°ê²° íƒ­ â€” URL í…ŒìŠ¤íŠ¸ + ì €ì¥
    document.getElementById('cfg-test-btn').addEventListener('click', async () => {
      const url = document.getElementById('cfg-url').value.trim();
      if (!url) { setCfgMsg('cfg-url-msg', 'URLì„ ì…ë ¥í•˜ì„¸ìš”.', 'err'); return; }
      setCfgMsg('cfg-url-msg', 'í…ŒìŠ¤íŠ¸ ì¤‘â€¦', '');
      try {
        const res = await fetch(`${url}?date=test&_=${Date.now()}`);
        const json = await res.json();
        if (json.error && !json.ok && !json.exists) throw new Error(json.error);
        setCfgMsg('cfg-url-msg', 'âœ… ì—°ê²° ì„±ê³µ!', 'ok');
      } catch (e) { setCfgMsg('cfg-url-msg', 'âŒ ì—°ê²° ì‹¤íŒ¨. URL ë˜ëŠ” ë°°í¬ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.', 'err'); }
    });
    document.getElementById('cfg-save-url-btn').addEventListener('click', () => {
      const url = document.getElementById('cfg-url').value.trim();
      if (!url) return;
      scriptUrl = url; localStorage.setItem('planner_script_url', url);
      document.getElementById('sync-badge').classList.remove('no-sync');
      setSyncStatus('ok', 'âœ“ ì—°ê²°ë¨');
      setCfgMsg('cfg-url-msg', 'âœ… URLì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ok');
    });

    // ê³„ì • íƒ­ â€” ì´ë¦„ + ì´ë©”ì¼ ì €ì¥ ë° ì„œë²„ ë“±ë¡
    document.getElementById('cfg-acct-save-btn').addEventListener('click', async () => {
      const name = document.getElementById('cfg-name').value.trim();
      const email = document.getElementById('cfg-email').value.trim().toLowerCase();
      if (!email || !email.includes('@')) { setCfgMsg('cfg-acct-msg', 'Gmail ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'err'); return; }
      localStorage.setItem('planner_name', name);
      localStorage.setItem('planner_email', email);
      // ì´ë©”ì¼ ì•Œë¦¼ ìë™ ë“±ë¡
      if (scriptUrl) {
        try {
          const res = await fetch(scriptUrl, {
            method: 'POST',
            body: JSON.stringify({ action: 'registerUser', email, name }),
            headers: { 'Content-Type': 'text/plain' }
          });
          const json = await res.json();
          const msg = json.already ? 'âœ… ì €ì¥ë¨ (ì´ë¯¸ ë“±ë¡ëœ ì´ë©”ì¼)' : 'âœ… ì €ì¥ ë° ì•Œë¦¼ ë“±ë¡ ì™„ë£Œ!';
          setCfgMsg('cfg-acct-msg', msg, 'ok');
        } catch (e) { setCfgMsg('cfg-acct-msg', 'âœ… ë¡œì»¬ ì €ì¥ ì™„ë£Œ (ì„œë²„ ì €ì¥ ì‹¤íŒ¨)', 'ok'); }
      } else {
        setCfgMsg('cfg-acct-msg', 'âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (Sheets ë¯¸ì—°ê²°).', 'ok');
      }
    });
    function setCfgMsg(id, msg, cls) {
      const el = document.getElementById(id);
      el.textContent = msg; el.className = 'modal-msg ' + cls;
    }

    /* ============================================================
       SHARE MODAL
    ============================================================ */
    document.getElementById('share-btn').addEventListener('click', () => {
      if (!scriptUrl) { showToast('ë¨¼ì € Sheetsë¥¼ ì—°ê²°í•´ ì£¼ì„¸ìš” (âš™ï¸ ì„¤ì •)'); return; }
      document.getElementById('share-date-label').textContent = currentDate + ' (' + getWeekday(currentDate) + ')';
      document.getElementById('share-modal').style.display = 'block';
      document.getElementById('share-msg').textContent = '';
    });
    function closeShareModal() { document.getElementById('share-modal').style.display = 'none'; }
    document.getElementById('share-modal-close').addEventListener('click', closeShareModal);
    document.getElementById('share-cancel-btn').addEventListener('click', closeShareModal);
    document.getElementById('share-overlay').addEventListener('click', closeShareModal);

    document.getElementById('share-send-btn').addEventListener('click', async () => {
      const recipients = (getShareTagCtrl() || { getEmails: () => [] }).getEmails();
      if (!recipients.length) { setModalMsg('share-msg', 'ìˆ˜ì‹ ìë¥¼ ìµœì†Œ 1ëª… ì…ë ¥í•´ ì£¼ì„¸ìš”.', 'err'); return; }
      const senderEmail = localStorage.getItem('planner_email') || '';
      const senderName = localStorage.getItem('planner_name') || senderEmail || 'ìµëª…';
      const plannerData = collectData();
      setModalMsg('share-msg', 'ë°œì†¡ ì¤‘â€¦', '');
      try {
        const res = await fetch(scriptUrl, {
          method: 'POST',
          body: JSON.stringify({ action: 'shareSchedule', date: currentDate, senderEmail, senderName, recipients, plannerData }),
          headers: { 'Content-Type': 'text/plain' }
        });
        const json = await res.json();
        if (json.error) throw new Error(json.error);
        setModalMsg('share-msg', `âœ… ${json.emailsSent}ëª…ì—ê²Œ ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'ok');
        setTimeout(closeShareModal, 2000);
      } catch (e) { setModalMsg('share-msg', `âŒ ${e.message}`, 'err'); }
    });

    function setModalMsg(id, msg, cls) {
      const el = document.getElementById(id);
      el.textContent = msg; el.className = 'modal-msg ' + cls;
    }

    /* ============================================================
       NOTICE BOARD
    ============================================================ */

    // ê³µì§€ ë¶ˆëŸ¬ì˜¤ê¸° (10ë¶„ë§ˆë‹¤ ìë™ ê°±ì‹ )
    async function fetchNotice() {
      if (!scriptUrl) return;
      try {
        const res = await fetch(`${scriptUrl}?action=getNotice&_=${Date.now()}`);
        const json = await res.json();
        if (json.error) return;
        const card = document.getElementById('notice-card');
        if (card) card.style.display = '';

        const container = document.getElementById('notice-list-container');
        const dot = document.getElementById('notice-dot');

        if (json.notices && json.notices.length > 0) {
          if (container) container.innerHTML = '';
          json.notices.forEach(n => {
            const item = document.createElement('div');
            item.innerHTML = `
              <div class="notice-title" style="font-size:.85rem; font-weight:700; color:var(--text); display:flex; justify-content:space-between; cursor:pointer; padding: 10px; background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius-sm); margin-bottom:5px;">
                <span style="display:flex; gap:6px; align-items:center;">ğŸ“¢ ${n.title}</span>
                <span style="font-size:.7rem; color:var(--text-muted);">${n.date}</span>
              </div>
              <div class="notice-content-body" style="display:none; padding:12px 14px; background: linear-gradient(135deg, rgba(232, 131, 74, .08), rgba(240, 192, 74, .05)); border: 1px solid rgba(232, 131, 74, .2); border-radius: var(--radius-sm); margin-bottom: 10px; font-size:.82rem; color:var(--text); line-height:1.7; white-space:pre-wrap;">${n.content}
<div style="font-size:.68rem; color:var(--text-dim); margin-top:10px; text-align:right;">â€” ${n.author} (${n.updatedAt})</div>
              </div>
            `;
            item.querySelector('.notice-title').addEventListener('click', function () {
              const b = this.nextElementSibling;
              b.style.display = b.style.display === 'none' ? 'block' : 'none';
            });
            if (container) container.appendChild(item);
          });
          if (dot) dot.style.display = 'inline-block';
        } else {
          if (container) container.innerHTML = '<div class="notice-text">ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          if (dot) dot.style.display = 'none';
        }
      } catch (e) { /* ì˜¤í”„ë¼ì¸ ë¬´ì‹œ */ }
    }
    // 10ë¶„ë§ˆë‹¤ ê°±ì‹ 
    setInterval(fetchNotice, 10 * 60 * 1000);

    function setNoticeMsg(msg, cls) {
      const el = document.getElementById('notice-post-msg');
      el.textContent = msg; el.className = 'notice-msg ' + cls;
    }

    // ì´ë©”ì¼ ë“±ë¡
    document.getElementById('email-register-btn').addEventListener('click', async () => {
      if (!scriptUrl) {
        setEmailMsg('ë¨¼ì € Google Sheetsë¥¼ ì—°ê²°í•˜ì„¸ìš”.', 'err'); return;
      }
      const email = document.getElementById('user-email-input').value.trim().toLowerCase();
      if (!email || !email.includes('@gmail.com')) {
        setEmailMsg('Gmail ì£¼ì†Œ(@gmail.com)ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.', 'err'); return;
      }
      setEmailMsg('ë“±ë¡ ì¤‘â€¦', '');
      try {
        const res = await fetch(scriptUrl, {
          method: 'POST',
          body: JSON.stringify({ action: 'registerUser', email }),
          headers: { 'Content-Type': 'text/plain' }
        });
        const json = await res.json();
        if (json.error) throw new Error(json.error);
        if (json.already) {
          setEmailMsg('âœ… ì´ë¯¸ ë“±ë¡ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.', 'ok');
        } else {
          setEmailMsg('âœ… ë“±ë¡ ì™„ë£Œ! ìƒˆ ê³µì§€ê°€ ì˜¤ë©´ ì´ë©”ì¼ë¡œ ì•Œë¦¼ì„ ë“œë¦½ë‹ˆë‹¤.', 'ok');
          localStorage.setItem('planner_email', email);
        }
      } catch (e) {
        setEmailMsg('âŒ ë“±ë¡ ì‹¤íŒ¨: ' + e.message, 'err');
      }
    });

    // ì €ì¥ëœ ì´ë©”ì¼ ìë™ ì±„ìš°ê¸°
    const savedEmail = localStorage.getItem('planner_email');
    if (savedEmail) document.getElementById('user-email-input').value = savedEmail;

    function setEmailMsg(msg, cls) {
      const el = document.getElementById('email-register-msg');
      el.textContent = msg; el.className = 'notice-msg ' + cls;
    }

    /* ============================================================
       INIT
    ============================================================ */

    // Restore theme
    if (localStorage.getItem('timebox_theme') === 'white') applyTheme(true);

    // Update sync badge based on saved URL
    if (scriptUrl) {
      document.getElementById('sync-badge').classList.remove('no-sync');
      setSyncStatus('ok', 'âœ“ ì—°ê²°ë¨');
    }

    buildPriorities();
    buildTimeblocks();

    // Show setup wizard if no URL yet, otherwise show planner
    if (!scriptUrl && !localStorage.getItem('planner_setup_done')) {
      openSetup();
    } else {
      localStorage.setItem('planner_setup_done', '1');
      closeSetup();
      document.getElementById('date-input').value = currentDate;
      document.getElementById('date-weekday').textContent = getWeekday(currentDate);
      loadPage(currentDate);
      fetchNotice(); // ê³µì§€ ë¡œë“œ
    }
  </script>

</body>

</html>